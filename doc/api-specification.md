API Specification
=================

This document is a DRAFT

This specification describes the API through which MOJ's [court and tribunal finder](https://courttribunalfinder.service.gov.uk) sends court data to GDS in order to produce individual court pages on www.gov.uk. The administration and search functionality of courts are out of the scope of this document, as well as operational aspects such as message queuing, retry-on-error, logging and monitoring.

Throughout this document, the term sender is used to refer to the system pushing the court data through the API, while the term receiver denotes the system receiving the data and publishing a representation of it online. The terms 'must', 'may' and 'should' follow the definitions in [RFC 2119](https://www.ietf.org/rfc/rfc2119.txt)

Principles
----------

### How a court is described

A court is described by a collection of properties encoded as text. For instance, the court's name, or its address, as well as some binary data representing a court's picture.

Those properties are organised in a hierarchy. For instance, a court can have multiple addresses, each of which having one town name. JSON is used to serialise the textual data passed through the API, while JPG is used for encoding a court's picture.

### Court identifiers

A court is identified by a UUID, which the sender generates for new courts and uses to modify or delete existing courts. The format of court UUIDs must match the following regexp (in [Ruby syntax](http://ruby-doc.org/core-2.1.1/Regexp.html):

    UUID_PATTERN = %r{
      \A
      [a-f\d]{8}
      -
      [a-f\d]{4}
      -
      [1-5]   # Version: http://tools.ietf.org/html/rfc4122#section-4.1.3
      [a-f\d]{3}
      -
      [89ab]  # Variant: http://tools.ietf.org/html/rfc4122#section-4.1.1
      [a-f\d]{3}
      -
      [a-f\d]{12}
      \z
    }x

From the [content-store on 23-12-2014](https://github.com/alphagov/content-store/blob/aa640fa8e29338afce5c4448d4c8b7a23fa06cbe/app/validators/uuid_validator.rb)

A court's UUID must never change in the lifetime of a court. A UUID must also never be reused after a court has been deleted.


API calls
---------

### Court creation or change

    PUT https://{base}/{uuid}

change or create a court.

`base` is predefined by the receiver. The body of the request contains the description of the court, which must conform to the court JSON schema described below. Upon receiving the data, the receiver generates or updates a court page.

On success, the receiver responds with a `201 Created` status code if a new court is created (as a result of the sender passing a new UUID passed in the request URL), or a `200 OK` if the call updates an existing court.

In both cases, the body of the response must be a JSON string containing the full URL of the court's public page:

    {"public_url":"https://www.gov.uk/{prefix}/{slug}"}

The `prefix` is generated by the receiver and the `slug` must be the same as that passed in the court JSON object.

The URL returned is not necessarily the URL that is passed in the PUT call.

If a court's slug changes, the receiver must create HTTP redirects of the public URLs to avoid broken links.

Errors are returned through standard HTTP response codes: 4XX on sender errors (eg, 422 if the court data passed is invalid) and 5XX on server errors. Response bodies should return helpful information about the error.

### Court deletion

In rare circumstances, typically following the mistaken creation of a court, a court's page needs to be removed from public view. The sender sends:

    DELETE https://{base}/{uuid}

The receiver must return one of the standard HTTP response codes, as above, with optional informative response body. The receiver must alter the corresponding court page so that it is no longer visible to the public. The UUID of a deleted court must never be reused.

The sender must not use this API call to indicate that a court or a tribunal has been closed. In that case, a court modification request is sent, with `"closed":true` in the court data passed.

### Fetching court information

    GET https://{base}/{uuid}

retrieve court data. If an existing UUID is passed, the receiver must return `200 OK`, and the response body must be the corresponding court object, which must conform to the JSON format for courts. The receiver returns `404 Not Found` in case no court exists with the UUID passed, or other standard error codes are sent in case of other errors.

    GET https://{base}/courts

Return the list of courts.

> TODO: format of the list

### Asset upload

    POST /court-picture/<uuid>

Send the picture of the court with the UUID passed. The content type must be `multipart/form-data`.

The response body must include the public URL of the uploaded image:

    {"public_url":"https://www.gov.uk/[image_url]"}

> any restrictions on file size, image size, image format, etc?

> Do we need to do a PUT after a picture upload? Doesn't seem necessary

Payload
-------

All court data passed through the API by the sender or the receiver (in the body of API requests) must be encoded in UTF-8 and must validate against the JSON-schema below. Moreover, the text fields in the payload must be plain text and must not contain any formatting elements: markup (like HTML or Markdown), escape sequences (eg `&amp;` or '\n').

> TODO: Court JSON schema


Court slugs
-----------

Court slugs are the court-specific part of courts public URIs, for instance `https://www.gov.uk/court/alderton-magistrates-court`. Court slugs are generated by the sender, and passed to the receiver in the body of a court creation/update call.

The sender may change a slug arbitrarily but a slug must always follow the [URL standards for GOV.UK](https://insidegovuk.blog.gov.uk/url-standards-for-gov-uk/). It is the sender's responsibility to ensure that no two courts have the same slug. The receiver must reject a court with the same slug as an existing one with a different UUID.

The method for generating a slug from a court name is described below. Since a court's slug may be modified independently of the court's name (ie, by hand in the admin interface) this algorithm is not mandatory.

> Do we really need to specify that algorithm, since the only constraint is that the URL standards are followed?
